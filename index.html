// Reemplaza la función descargarArchivo existente por esta:
function descargarArchivo() {
  // Si hay sesión con backend, usa la ruta del API (tu backend.js)
  if (typeof currentUserId !== 'undefined' && currentUserId) {
    // intenta usar el backend
    try {
      window.location.href = API + '/descargar/' + currentUserId + '/GrepoBot.user.js';
      return;
    } catch (e) {
      // caemos al fallback
    }
  }
  // FALLBACK: abrir el archivo local GrepoBot.user.js (debe estar en la misma carpeta)
  window.open('GrepoBot.user.js', '_blank');
}

// Añade estas utilidades para comprobar backend (cache corto)
let _backendCheck = { ok: null, ts: 0 };
async function checkBackendAvailable() {
  // cache 3s
  if (_backendCheck.ts && (Date.now() - _backendCheck.ts) < 3000) return _backendCheck.ok;
  _backendCheck.ts = Date.now();
  try {
    const res = await fetch(API + '/paypal/create-order', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({planId:'1_MES'}) , mode: 'cors' });
    // si responde JSON probablemente hay backend (puede devolver id o error)
    _backendCheck.ok = res.ok;
    return _backendCheck.ok;
  } catch (err) {
    _backendCheck.ok = false;
    return false;
  }
}

// Reemplaza renderPayPalButtons por esta versión (fallback cliente)
function renderPayPalButtons() {
  document.getElementById('paypal-button-container').innerHTML = '';
  paypal.Buttons({
    style: { color: 'gold', shape: 'rect', label: 'paypal', height: 45 },
    createOrder: async function(data, actions) {
      // Intenta backend primero
      const backendUp = await checkBackendAvailable();
      if (backendUp) {
        // pide al backend crear orden (igual que antes)
        return fetch(API + '/paypal/create-order', {
          method: 'post',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({ planId: selectedPlanId })
        }).then(res => res.json()).then(orderData => orderData.id);
      } else {
        // FALLBACK: crea orden en cliente (sandbox demo)
        return actions.order.create({
          purchase_units: [{
            description: selectedPlanId + " GrepoBot Pro",
            amount: { value: (selectedPlanId === '1_MES' ? '7.99' : (selectedPlanId === '6_MESES' ? '45.00' : '80.00')) }
          }]
        });
      }
    },
    onApprove: async function(data, actions) {
      const backendUp = await checkBackendAvailable();
      if (backendUp) {
        // captura en backend (tu lógica original)
        return fetch(API + '/paypal/capture-order', {
          method: 'post',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ orderID: data.orderID, usuarioId: currentUserId, planId: selectedPlanId })
        }).then(res => res.json()).then(details => {
          alert('✅ ¡PAGO COMPLETADO! Licencia renovada.');
          location.reload();
        }).catch(e=>{
          alert('Pago completado pero error al notificar backend. Refresca la página.');
        });
      } else {
        // FALLBACK: orden aprobada en cliente (demo)
        alert('Pago completado en sandbox (demo). Gracias por renovar GrepoBot Pro.');
        // Si quieres, aquí puedes actualizar UI sin backend:
        document.getElementById('status-licencia').className = 'alert success';
        document.getElementById('status-licencia').innerHTML = '✅ <b>Licencia Activa</b> (30 días demo)';
      }
    },
    onError: function(err) {
      console.error('PayPal error', err);
      alert('Error con PayPal. Desactiva bloqueadores y prueba en otro navegador.');
    }
  }).render('#paypal-button-container');
}