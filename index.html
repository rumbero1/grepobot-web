<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>GrepoBot - Panel</title>
  <style>
    body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial; padding: 20px; color:#111; background:#f7f7f8; }
    .card { background:#fff; padding:16px; border-radius:8px; box-shadow:0 2px 8px rgba(0,0,0,0.06); max-width:900px; margin:auto; }
    .row { display:flex; gap:8px; align-items:center; margin-bottom:8px; }
    input[type="text"] { padding:6px 8px; border:1px solid #d0d0d5; border-radius:6px; width:250px; }
    button { padding:8px 12px; border-radius:6px; border:0; background:#1266f1; color:#fff; cursor:pointer; }
    #status { margin-top:12px; font-weight:600; }
    #paypal-button-container { margin-top:16px; }
    pre { background:#111; color:#e6e6e6; padding:8px; border-radius:6px; max-height:240px; overflow:auto; }
  </style>
</head>
<body>
  <div class="card">
    <h2>GrepoBot — Panel de pago / descarga</h2>
    <div class="row">
      <label>usuarioId:</label>
      <input id="usuarioId" type="text" value="1" />
      <label>token:</label>
      <input id="token" type="text" placeholder="token (opcional para descargar)" />
      <button id="btnReload">Recargar PayPal SDK</button>
      <button id="btnForceSb">Forzar SDK (sandbox)</button>
    </div>

    <div id="status">Estado: esperando acciones...</div>

    <div id="paypal-button-container"></div>

    <h3>Descarga del userscript</h3>
    <div class="row">
      <select id="variant">
        <option value="tampermonkey-full">tampermonkey-full</option>
        <option value="tampermonkey-trial">tampermonkey-trial</option>
      </select>
      <button id="btnDownload">Descargar userscript</button>
    </div>

    <h3>Consola rápida (solo lectura)</h3>
    <pre id="log"></pre>
  </div>

<script>
(async function(){
  const $ = id => document.getElementById(id);
  const logEl = $('log');
  function log(...args){ console.log(...args); logEl.textContent += args.map(a=>typeof a === 'object' ? JSON.stringify(a,null,2) : String(a)).join(' ') + '\n'; logEl.scrollTop = 9999; }
  function setStatus(t){ $('status').innerText = 'Estado: ' + t; log('STATUS:', t); }

  // Helper: load config from backend
  async function getConfig(){
    try {
      const r = await fetch('/api/config');
      if (!r.ok) throw new Error('config fetch status ' + r.status);
      return await r.json();
    } catch(e){
      log('Error al leer /api/config:', e.message || e);
      return { paypalClientId:'', paypalMode:'sandbox', currency:'USD' };
    }
  }

  // Remove any existing paypal sdk script tags that match sdk/js
  function removeExistingPayPalScripts(){
    const existing = Array.from(document.scripts).filter(s=>s.src && s.src.includes('paypal.com/sdk/js'));
    existing.forEach(s=>s.remove());
    if(existing.length) log('Se eliminaron scripts PayPal existentes:', existing.map(s=>s.src));
  }

  // Load PayPal SDK dynamically. clientId may be 'sb' for sandbox.
  function loadPayPalSdk(clientId, currency){
    return new Promise((resolve, reject) => {
      try {
        removeExistingPayPalScripts();
        // avoid duplicate
        if (Array.from(document.scripts).some(s=>s.src && s.src.includes('paypal.com/sdk/js'))) {
          log('PayPal SDK ya estaba presente');
        }
        const s = document.createElement('script');
        s.src = 'https://www.paypal.com/sdk/js?client-id=' + encodeURIComponent(clientId) + '&currency=' + encodeURIComponent(currency || 'USD');
        s.async = true;
        s.onload = () => { log('paypal sdk loaded ->', s.src); resolve(s.src); };
        s.onerror = (ev) => { log('paypal sdk load error', ev); reject(new Error('paypal sdk load error')); };
        document.head.appendChild(s);
      } catch(e){
        reject(e);
      }
    });
  }

  // Render PayPal Buttons (uses backend endpoints)
  function renderPayPalButtons(){
    const container = $('paypal-button-container');
    container.innerHTML = '';
    if (!window.paypal) {
      setStatus('PayPal SDK no presente');
      return;
    }
    setStatus('Renderizando botones PayPal...');
    paypal.Buttons({
      style: { layout: 'vertical' },
      createOrder: function(data, actions){
        setStatus('Creando orden en backend...');
        // backend create-order returns { id: 'TEST_xxx' } for simulation
        return fetch('/api/paypal/create-order', {
          method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ planId: '1_MES', usuarioId: parseInt($('usuarioId').value || '1',10) })
        }).then(r=>r.json()).then(j=>{
          if (j && j.id) {
            log('create-order result:', j);
            setStatus('Orden creada: ' + j.id);
            return j.id;
          }
          throw new Error('create-order response invalid: ' + JSON.stringify(j));
        }).catch(e=>{
          setStatus('Error creando orden');
          log('create-order error', e);
          throw e;
        });
      },
      onApprove: function(data, actions){
        setStatus('Capturando orden en backend...');
        // call capture-order in backend to mark purchased
        return fetch('/api/paypal/capture-order', {
          method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ usuarioId: parseInt($('usuarioId').value || '1',10), planId: '1_MES' })
        }).then(r=>r.json()).then(j=>{
          log('capture-order result:', j);
          if (j && j.success) {
            setStatus('Pago simulado completado — días añadidos: ' + (j.daysAdded || j.daysAdded===0 ? j.daysAdded : 'n/a'));
            // Optionally refresh license status or UI
            return j;
          }
          setStatus('Error en captura de orden');
          throw new Error('capture-order failed: ' + JSON.stringify(j));
        }).catch(e=>{
          setStatus('Error al capturar orden');
          log('capture-order error', e);
          throw e;
        });
      },
      onError: function(err){
        setStatus('Error PayPal: ' + (err && err.message ? err.message : err));
        log('paypal onError:', err);
      }
    }).render('#paypal-button-container');
  }

  // Download userscript (uses token and usuarioId)
  async function downloadScript(){
    const usuarioId = $('usuarioId').value || '';
    const token = $('token').value || '';
    const variant = $('variant').value || 'tampermonkey-full';
    if (!usuarioId) { alert('Introduce usuarioId'); return; }
    if (!token) { if(!confirm('No ha introducido token. ¿Continuar sin token (probablemente 403)?')) return; }
    const url = '/api/descargar?usuarioId=' + encodeURIComponent(usuarioId) + '&variant=' + encodeURIComponent(variant) + '&filename=GrepoBot.user.js' + (token ? '&token=' + encodeURIComponent(token) : '');
    setStatus('Solicitando descarga...');
    try {
      const headers = token ? { 'Authorization': 'Bearer ' + token } : {};
      const r = await fetch(url, { headers });
      if (!r.ok) {
        const j = await r.json().catch(()=>({ error: 'no-json' }));
        setStatus('Error descarga: ' + (j && j.error ? j.error : r.status));
        log('descarga error resp:', r.status, j);
        alert('Error al descargar: ' + (j && j.error ? j.error : r.status));
        return;
      }
      const txt = await r.text();
      // trigger client download
      const blob = new Blob([txt], { type: 'application/javascript;charset=utf-8' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'GrepoBot.user.js';
      document.body.appendChild(a);
      a.click();
      a.remove();
      setStatus('Descarga completada (archivo guardado en tu navegador).');
      log('descarga ok, tamaño:', txt.length);
    } catch(e){
      setStatus('Error en descarga');
      log('downloadScript error', e);
      alert('Error al descargar. Mira la consola para más detalles.');
    }
  }

  // UI wiring
  $('btnReload').addEventListener('click', async ()=> {
    setStatus('Recargando SDK usando /api/config...');
    const cfg = await getConfig();
    const clientId = (cfg.paypalClientId && cfg.paypalClientId.trim()) ? cfg.paypalClientId.trim() : 'sb';
    try {
      await loadPayPalSdk(clientId, cfg.currency || 'USD');
      renderPayPalButtons();
      setStatus('SDK recargado con client-id=' + clientId);
    } catch(e){
      setStatus('Error cargando SDK: ' + (e.message || e));
      log('load error', e);
    }
  });

  $('btnForceSb').addEventListener('click', async ()=> {
    setStatus('Forzando SDK sandbox (sb)...');
    try {
      await loadPayPalSdk('sb', 'USD');
      renderPayPalButtons();
      setStatus('SDK sandbox cargado');
    } catch(e){
      setStatus('Error cargando SDK sandbox');
      log('force sb error', e);
    }
  });

  $('btnDownload').addEventListener('click', ()=> downloadScript());

  // Auto load on page open
  try {
    setStatus('Inicializando, leyendo /api/config...');
    const cfg = await getConfig();
    const clientId = (cfg.paypalClientId && cfg.paypalClientId.trim()) ? cfg.paypalClientId.trim() : 'sb';
    await loadPayPalSdk(clientId, cfg.currency || 'USD');
    renderPayPalButtons();
    setStatus('Panel listo — PayPal SDK cargado con client-id=' + clientId);
  } catch(e){
    setStatus('No se pudo inicializar PayPal SDK: ' + (e.message || e));
    log('init error', e);
  }
})();
</script>
</body>
</html>
