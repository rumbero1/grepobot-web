<!-- AÑADE en <head> (poner tu sandbox client-id aquí o mantenerlo temporal) -->
<meta name="paypal-client-id" content="ARI8xtvx-zlykSa7RFIka_g5C3_iF8-CaK_ipoT_L9C_mDJiuUyTgTv_HLLHeXNPHrlwRQbmcPmYWIGs">

<!-- En tu script principal (reemplaza la gestión de login/descarga y PayPal) -->
<script>
  const API = location.origin; // "https://grepobot-web.onrender.com" en remoto
  // Si usas local/testing, cambia API a la URL correcta.
  let currentUserId = Number(localStorage.getItem('currentUserId')) || null;

  // LOGIN: al recibir respuesta del backend, guarda usuarioId
  function handleLoginResponse(respJson) {
    if (respJson && respJson.success && respJson.usuarioId) {
      currentUserId = respJson.usuarioId;
      localStorage.setItem('currentUserId', String(currentUserId));
      // actualizar UI: mostrar usuario logueado...
    } else {
      // mostrar error...
    }
  }

  // Example: llamada de login (usa tu formulario)
  function doLogin(username, password) {
    fetch(API + '/api/login', {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({username, password})
    }).then(r=>r.json()).then(json=>{
      handleLoginResponse(json);
    }).catch(e=>console.error(e));
  }

  // DESCARGA: usar API con usuarioId; evitar abrir archivo raíz
  function descargarArchivo() {
    if (!currentUserId) {
      alert('Debes iniciar sesión antes de descargar.');
      return;
    }
    const headUrl = `${API}/api/descargar/${currentUserId}/GrepoBot.user.js`;
    // HEAD para comprobar disponibilidad (opcional)
    fetch(headUrl, { method: 'HEAD' })
      .then(r => {
        if (r.ok) {
          // fuerza la descarga/navegador abrir la URL de la API
          window.location.href = headUrl;
        } else {
          // fallback: abrir la versión pública si existe
          window.location.href = `${API}/GrepoBot.user.js`;
        }
      }).catch(()=> {
        // fallback local
        window.location.href = `${API}/GrepoBot.user.js`;
      });
  }

  // PAYPAL: cargar SDK dinámicamente usando client-id del meta
  function loadPayPalSdkAndRenderButtons(containerSelector) {
    const meta = document.querySelector('meta[name="paypal-client-id"]');
    const clientId = meta ? meta.content.trim() : '';

    if (!clientId) {
      console.warn('PayPal client-id no configurado en meta[name="paypal-client-id"]');
      return;
    }

    const sdkUrl = `https://www.paypal.com/sdk/js?client-id=${encodeURIComponent(clientId)}&currency=USD`;
    if (!document.querySelector(`script[src^="${sdkUrl.split('?')[0]}"]`)) {
      const s = document.createElement('script');
      s.src = sdkUrl;
      s.async = true;
      s.onload = () => {
        renderPayPalButtons(containerSelector);
      };
      s.onerror = () => console.error('Error cargando PayPal SDK');
      document.head.appendChild(s);
    } else {
      renderPayPalButtons(containerSelector);
    }
  }

  function renderPayPalButtons(containerSelector) {
    if (typeof paypal === 'undefined') {
      console.error('paypal SDK no disponible');
      return;
    }
    paypal.Buttons({
      createOrder: function(data, actions) {
        // pide al backend un order id (server creates the order and returns id)
        return fetch(API + '/api/paypal/create-order', {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify({ planId: '1_MES' }) // elegir plan según UI
        }).then(res => res.json()).then(data => {
          if (!data || !data.id) throw new Error('No order id from server');
          return data.id;
        });
      },
      onApprove: function(data, actions) {
        // captura en backend y activa la cuenta
        return fetch(API + '/api/paypal/capture-order', {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify({ orderID: data.orderID, usuarioId: currentUserId || null, planId: '1_MES' })
        }).then(res => res.json()).then(resp => {
          if (resp && resp.success) {
            alert('Pago recibido. Licencia activada.');
            // permite descarga de nuevo:
            if (currentUserId) {
              // reset flag de descarga si lo usas
            }
          } else {
            alert('Error en la activación del pago: ' + (resp.error || 'unknown'));
          }
        });
      },
      onError: function(err) {
        console.error('PayPal Buttons error', err);
        alert('Error con PayPal. Intenta en otra ventana sin bloqueadores.');
      }
    }).render(containerSelector);
  }

  // Al cargar la página: inicializar PayPal button en tu contenedor
  document.addEventListener('DOMContentLoaded', function() {
    // ejemplo: #paypal-button-container
    loadPayPalSdkAndRenderButtons('#paypal-button-container');

    // conecta el botón INSTALAR con la función correcta:
    const installBtn = document.querySelector('#install-button'); // ajusta selector
    if (installBtn) installBtn.addEventListener('click', descargarArchivo);
  });
</script>
