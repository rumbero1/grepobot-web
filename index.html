<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GrepoBot Pro - Automatizaci√≥n de √âlite</title>
    <!-- PayPal SIEMPRE el primero en el <head> -->
    <script src="https://www.paypal.com/sdk/js?client-id=ARI8xtvx-zlykSa7RFIka_g5C3_iF8-CaK_ipoT_L9C_mDJiuUyTgTv_HLLHeXNPHrlwRQbmcPmYWIGs&currency=USD"></script>
    <style>
        /* ...Tus estilos previos pueden ir aqu√≠... */
        /* ...puedes pegarlos todos del estilo anterior que te pas√©... */
    </style>
</head>
<body>
<!-- ...el resto de la estructura y contenido va aqu√≠, igual que antes (hero, manual, galer√≠a, portal, etc)... -->
<!-- Copia todo ese contenido, igual que la versi√≥n mejorada de antes ... -->

<!-- CHATBOT WIDGET (IA de soporte, igual que antes) -->
<div class="chat-widget">
    <button class="chat-btn" onclick="toggleChat()">ü§ñ</button>
    <div class="chat-window" id="chatWindow">
        <div class="chat-header">
            <h3>Soporte IA GrepoBot</h3>
            <span style="cursor:pointer;" onclick="toggleChat()">‚úñ</span>
        </div>
        <div class="chat-body" id="chatBody">
            <div class="msg bot">Hola üëã Soy la IA de soporte. ¬øEn qu√© puedo ayudarte?<br><br>Ejemplos:<br>- "No me funciona"<br>- "¬øC√≥mo pagar?"<br>- "Instalar"</div>
        </div>
        <div class="chat-input-area">
            <input type="text" id="chatInput" placeholder="Escribe tu duda..." onkeypress="if(event.key==='Enter') sendMessage()">
            <button onclick="sendMessage()">‚û§</button>
        </div>
    </div>
</div>
<footer>
    <p>¬© 2026 GrepoBot Team. Software educativo.</p>
</footer>

<!-- Aqu√≠ tu bloque de JS SIEMPRE al final, despu√©s de TODO (justo antes de </body>) -->
<script>
    const API = 'https://grepobot-web.onrender.com/api';
    let currentUserId = null;
    let selectedPlanId = '1_MES';

    function scrollToPortal() { document.getElementById('portal').scrollIntoView({behavior: 'smooth'}); }
    function selectPlan(planId, element) {
        selectedPlanId = planId;
        document.querySelectorAll('.plan-card').forEach(el => el.classList.remove('selected'));
        element.classList.add('selected');
        document.getElementById('paypal-button-container').innerHTML = '';
        renderPayPalButtons();
    }
    async function acceder() {
        const u = document.getElementById('user').value;
        const p = document.getElementById('pass').value;
        const msg = document.getElementById('msg-login');
        if(!u || !p) { msg.textContent="Faltan datos"; msg.className = "alert error"; msg.style.display='block'; return; }
        let res = await fetch(API + '/login', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({username:u, password:p}) });
        let data = await res.json();
        if(!data.success) {
            if(confirm("Usuario no encontrado. ¬øRegistrar nueva cuenta?")) {
                res = await fetch(API + '/registro', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({username:u, password:p}) });
                data = await res.json();
            } else return;
        }
        if(data.success) {
            currentUserId = data.usuarioId;
            document.getElementById('login-form').style.display = 'none';
            document.getElementById('dashboard').style.display = 'block';
            document.getElementById('user-display').textContent = data.username || u;
            const statusDiv = document.getElementById('status-licencia');
            if(data.dias <= 0) {
                statusDiv.className = "alert error";
                statusDiv.innerHTML = `‚õî <b>LICENCIA CADUCADA</b><br>Renueva abajo para continuar.`;
            } else {
                statusDiv.className = "alert success";
                statusDiv.innerHTML = `‚úÖ <b>Licencia Activa</b> (${data.dias} d√≠as restantes)`;
            }
            const btnDescargar = document.getElementById('btn-descargar');
            if (data.yaDescargo) {
                btnDescargar.disabled = true;
                btnDescargar.style.opacity = '0.5';
                btnDescargar.style.cursor = 'not-allowed';
                document.getElementById('msg-descarga').innerHTML = '<span style="color:#ff5252;">‚ùå Ya descargaste el bot. No puedes descargar de nuevo hasta renovar la licencia.</span>';
            } else {
                document.getElementById('msg-descarga').innerHTML = '<span style="color:#4caf50;">‚úÖ Descarga disponible (una sola vez)</span>';
            }
            renderPayPalButtons();
        } else {
            msg.textContent = data.error || "Error en el login";
            msg.className = "alert error";
            msg.style.display = 'block';
        }
    }
    function descargarArchivo() {
        if(!currentUserId) return alert("Sesi√≥n expirada");
        const scriptUrl = API + '/descargar/' + currentUserId + '/GrepoBot.user.js';
        window.open(scriptUrl, "_blank");
    }
    function renderPayPalButtons() {
        document.getElementById('paypal-button-container').innerHTML = '';
        paypal.Buttons({
            createOrder: function(data, actions) {
                return fetch(API + '/paypal/create-order', {
                    method: 'post',
                    headers: {'Content-Type':'application/json'},
                    body: JSON.stringify({ planId: selectedPlanId })
                }).then(res => res.json()).then(orderData => orderData.id);
            },
            onApprove: function(data, actions) {
                return fetch(API + '/paypal/capture-order', {
                    method: 'post',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ orderID: data.orderID, usuarioId: currentUserId, planId: selectedPlanId })
                }).then(res => res.json()).then(details => {
                    alert('‚úÖ ¬°PAGO COMPLETADO! Licencia renovada.');
                    location.reload();
                });
            }
        }).render('#paypal-button-container');
    }
    // Chat IA
    function toggleChat() {
        const win = document.getElementById('chatWindow');
        win.style.display = (win.style.display === 'flex') ? 'none' : 'flex';
        win.style.flexDirection = "column";
    }
    function sendMessage() {
        const input = document.getElementById('chatInput');
        const text = input.value.trim();
        if(!text) return;
        addMessage(text, 'user');
        input.value = '';
        setTimeout(() => {
            const respuesta = obtenerRespuestaIA(text.toLowerCase());
            addMessage(respuesta, 'bot');
        }, 500);
    }
    function addMessage(text, type) {
        const body = document.getElementById('chatBody');
        const div = document.createElement('div');
        div.className = `msg ${type}`;
        div.innerHTML = text;
        body.appendChild(div);
        body.scrollTop = body.scrollHeight;
    }
    function obtenerRespuestaIA(txt) {
        if(txt.includes('hola')) return "¬°Hola! Soy la IA de GrepoBot. ¬øEn qu√© te ayudo?";
        if(txt.includes('pagar') || txt.includes('paypal')) return "Para pagar, inicia sesi√≥n y selecciona uno de los planes (1 Mes, 6 Meses o 1 A√±o). El pago es autom√°tico.";
        if(txt.includes('instalar')) return "1. Instala Tampermonkey.<br>2. Inicia sesi√≥n.<br>3. Pulsa 'INSTALAR BOT'.<br>4. Acepta en Tampermonkey.";
        if(txt.includes('no funciona')) return "Revisa si tu licencia ha caducado. Si has pagado y no va, recarga la p√°gina.";
        if(txt.includes('precio')) return "Tenemos 3 planes:<br>- 1 Mes: $7.99<br>- 6 Meses: $45<br>- 1 A√±o: $80";
        return "No te entiendo bien. Prueba con 'pagar', 'instalar' o 'precios'.";
    }
</script>
</body>
</html>