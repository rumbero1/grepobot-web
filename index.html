<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>GrepoBot Pro - Automatizaci√≥n de √âlite</title>

  <!-- PAYPAL: sandbox client-id (frontend-only; NO incluir secret) -->
  <meta name="paypal-client-id" content="AdyTzXlIYrlebiqUrzbNoW1SwBPibQEMEF1NC_XX9u-nXyldB_ZslkgcOoeGshlmourfrjxST7Omg3TT">

  <!-- Favicons / meta adicionales -->
  <link rel="icon" href="/favicon.ico" />

  <!-- Estilos b√°sicos (mantener/ajustar a tu CSS real) -->
  <style>
    :root {
      --primary: #4caf50;
      --dark: #121212;
      --card: #1e1e1e;
      --text: #e0e0e0;
      --muted: #a0a0a0;
    }
    html,body{height:100%;margin:0;background:var(--dark);color:var(--text);font-family:Inter,Segoe UI,Roboto,Arial;}
    nav{display:flex;justify-content:space-between;align-items:center;padding:16px 28px;background:rgba(0,0,0,0.75);border-bottom:1px solid #222}
    .logo{font-weight:700;color:var(--primary);letter-spacing:1px}
    .nav-actions button{margin-left:8px;padding:8px 12px;border-radius:6px;border:0;background:transparent;color:var(--text);cursor:pointer}
    .btn-primary{background:var(--primary);color:#fff;padding:10px 14px;border-radius:6px;border:0;cursor:pointer}
    .container{max-width:1100px;margin:28px auto;padding:0 20px}
    .hero{display:flex;gap:28px;align-items:center;padding:36px;background:linear-gradient(180deg,#161616,#0f0f0f);border-radius:10px}
    .hero .left{flex:1}
    .hero h1{font-size:34px;margin:0}
    .hero p{color:var(--muted);margin-top:8px}
    .card{background:var(--card);padding:18px;border-radius:8px;margin-top:18px}
    .grid{display:grid;grid-template-columns:1fr 340px;gap:20px}
    .muted{color:var(--muted);font-size:14px}
    img.responsive{max-width:100%;height:auto;border-radius:8px}
    footer{padding:24px;text-align:center;color:var(--muted)}
    .paypal-error-notice{background:#fff4f4;color:#8b0000;padding:10px;border-radius:6px;margin:10px 0;font-size:13px}
    .plan-card{background:#171717;padding:14px;border-radius:8px;flex:0 0 220px;cursor:pointer;border:2px solid transparent}
    .plan-card.selected{border-color:var(--primary)}
    .plan-card:hover{transform:translateY(-4px);transition:0.15s;box-shadow:0 6px 18px rgba(0,0,0,0.35)}
    .cta-button{padding:12px;border-radius:8px;border:0;cursor:pointer}
  </style>

  <!-- Loader tolerante de PayPal y helpers (NO tocar el resto del HTML) -->
  <script>
  (function(){
    // BASE API: usar el mismo origen donde est√° desplegada la web
    const API = location.origin + '/api';

    // estado global
    let currentUserId = Number(localStorage.getItem('currentUserId')) || null;
    let selectedPlan = '1_MES';

    // Permitir que el flujo de login/registro llame a esta funci√≥n
    window.handleLoginResponse = function(respJson){
      if (respJson && respJson.success && respJson.usuarioId){
        currentUserId = respJson.usuarioId;
        localStorage.setItem('currentUserId', String(currentUserId));
      }
    };

    // Descargar userscript v√≠a API por usuarioId (bot√≥n INSTALAR)
    window.descargarArchivo = function(){
      if (!currentUserId) {
        alert('Debes iniciar sesi√≥n antes de descargar.');
        return;
      }
      window.location.href = `${API}/descargar/${currentUserId}/GrepoBot.user.js`;
    };

    function showPayPalErrorNotice(msg){
      if (document.querySelector('.paypal-error-notice')) return;
      const n = document.createElement('div');
      n.className = 'paypal-error-notice';
      n.style.cssText = 'background:#fff4f4;color:#8b0000;padding:10px;border-radius:6px;margin:10px 0;font-size:13px';
      n.innerText = msg;
      const parent = document.querySelector('#paypal-area') || document.body;
      parent.insertBefore(n, parent.firstChild);
    }
    function hidePayPalContainer(sel){
      const c = document.querySelector(sel);
      if (c) c.style.display = 'none';
    }

    // Cargar SDK PayPal din√°micamente (si hay client-id)
    function loadPayPalSdkAndRenderButtons(containerSelector){
      const meta = document.querySelector('meta[name="paypal-client-id"]');
      const clientId = meta ? meta.content.trim() : '';
      if (!clientId) {
        console.warn('PayPal client-id no configurado; ocultando PayPal.');
        hidePayPalContainer(containerSelector);
        showPayPalErrorNotice('PayPal no est√° configurado. Contacta al administrador.');
        return;
      }

      const sdkBase = 'https://www.paypal.com/sdk/js';
      const sdkUrl = `${sdkBase}?client-id=${encodeURIComponent(clientId)}&currency=USD`;

      // Evitar cargar dos veces
      const already = Array.from(document.scripts).some(s => s.src && s.src.startsWith(sdkBase));
      if (already) { waitForPaypalThenRender(containerSelector); return; }

      const s = document.createElement('script');
      s.src = sdkUrl;
      s.async = true;
      s.onload = () => { console.log('PayPal SDK cargado OK'); waitForPaypalThenRender(containerSelector); };
      s.onerror = (e) => { console.error('Error cargando PayPal SDK', e); hidePayPalContainer(containerSelector); showPayPalErrorNotice('No se pudo cargar PayPal. Desactiva bloqueadores o prueba otro navegador.'); };
      document.head.appendChild(s);

      setTimeout(()=>{ if (typeof paypal === 'undefined') { console.warn('PayPal SDK no disponible tras timeout'); hidePayPalContainer(containerSelector); } }, 8000);
    }

    function waitForPaypalThenRender(containerSelector){
      const maxWait = 8000, interval = 200;
      let waited = 0;
      const t = setInterval(()=>{
        if (typeof paypal !== 'undefined'){
          clearInterval(t);
          try { renderPayPalButtons(containerSelector); } catch(e){ console.error(e); hidePayPalContainer(containerSelector); }
        } else {
          waited += interval;
          if (waited >= maxWait) { clearInterval(t); hidePayPalContainer(containerSelector); }
        }
      }, interval);
    }

    // Crea la orden en backend para el plan seleccionado
    window.__Grepo_createOrderForSelectedPlan = async function(){
      try {
        const res = await fetch(API + '/paypal/create-order', {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify({ planId: selectedPlan })
        });
        const j = await res.json();
        if (!j || !j.id) throw new Error('No order id');
        return j.id;
      } catch (e) {
        console.error('Error creando orden', e);
        throw e;
      }
    };

    function renderPayPalButtons(containerSelector){
      if (typeof paypal === 'undefined') throw new Error('paypal SDK no disponible');
      const container = document.querySelector(containerSelector);
      if (!container) return;
      container.innerHTML = '';
      paypal.Buttons({
        createOrder: function(){ return window.__Grepo_createOrderForSelectedPlan(); },
        onApprove: function(data){
          return fetch(API + '/paypal/capture-order', {
            method: 'POST',
            headers: {'Content-Type':'application/json'},
            body: JSON.stringify({ orderID: data.orderID, usuarioId: currentUserId || null, planId: selectedPlan })
          }).then(r => r.json()).then(resp => {
            if (resp && resp.success) alert('Pago recibido. Licencia activada.');
            else alert('Error en la activaci√≥n del pago: ' + (resp.error || ''));
          }).catch(err => { console.error('Error capturando orden', err); alert('Error en la captura del pago.'); });
        },
        onError: function(err){ console.error('PayPal Buttons error', err); alert('Error con PayPal. Intenta en otra ventana sin bloqueadores.'); }
      }).render(containerSelector);
    }

    // Inicializador p√∫blico
    window.__Grepo_setSelectedPlan = function(planId){ selectedPlan = planId; if (typeof paypal !== 'undefined') { try{ renderPayPalButtons('#paypal-button-container'); }catch(e){console.warn(e);} } };
    window.__Grepo_initPayments = function(){ loadPayPalSdkAndRenderButtons('#paypal-button-container'); };

    document.addEventListener('DOMContentLoaded', function(){
      // enlazar bot√≥n de descarga si existe
      const topInstall = document.querySelector('#install-button');
      if (topInstall) topInstall.addEventListener('click', () => window.descargarArchivo());
      const sideInstall = document.querySelector('#btn-descargar');
      if (sideInstall) sideInstall.addEventListener('click', () => window.descargarArchivo());

      // inicializar PayPal (no bloqueante)
      window.__Grepo_initPayments();
    });
  })();
  </script>
</head>
<body>
  <nav>
    <div class="logo">GrepoBot Pro</div>
    <div class="nav-actions">
      <button id="btn-open-support" class="nav-btn">Soporte IA</button>
      <button id="login-open" class="nav-btn">Entrar</button>
      <button id="install-button" class="btn-primary">INSTALAR</button>
    </div>
  </nav>

  <main class="container">
    <!-- HERO -->
    <section class="hero">
      <div class="left">
        <h1>GrepoBot Pro ‚Äî Automatizaci√≥n de √âlite</h1>
        <p class="muted">El bot m√°s avanzado para Grepolis. Indetectable y con Soporte IA incluido.</p>
        <div style="margin-top:16px">
          <button id="cta-register" class="btn-primary">Crear cuenta</button>
          <button id="cta-login" class="btn-primary" style="background:#2d2d2d;margin-left:8px">Iniciar sesi√≥n</button>
        </div>
      </div>
      <div class="right" style="width:320px;text-align:center">
        <img src="/assets/hero.png" alt="GrepoBot" class="responsive"/>
      </div>
    </section>

    <div class="grid" style="margin-top:20px">
      <div>
        <section class="card" id="guide-section">
          <h2>Manual de uso</h2>
          <p class="muted">Sigue estos pasos para registrar tu cuenta, pagar y descargar el userscript:</p>
          <ol>
            <li>Reg√≠strate o inicia sesi√≥n en la web.</li>
            <li>Elige un plan y pulsa PayPal para pagar.</li>
            <li>Pulsa INSTALAR para descargar el userscript e inst√°lalo en Tampermonkey.</li>
          </ol>
        </section>

        <section class="card" id="support-ai">
          <h2>Soporte IA</h2>
          <p class="muted">Escribe tu duda y nuestra IA te dar√° pasos r√°pidos y comandos.</p>
          <textarea id="ai-question" style="width:100%;height:80px;background:#0f0f0f;color:var(--text);border-radius:6px;border:1px solid #222;padding:8px"></textarea>
          <div style="margin-top:8px"><button id="ai-send" class="btn-primary">Preguntar a la IA</button></div>
          <div id="ai-response" class="muted" style="margin-top:12px"></div>
        </section>

        <section class="card" id="images">
          <h2>Recursos</h2>
          <div style="display:flex;gap:8px;flex-wrap:wrap">
            <img src="/assets/screenshot1.png" alt="s1" style="width:160px;border-radius:6px"/>
            <img src="/assets/screenshot2.png" alt="s2" style="width:160px;border-radius:6px"/>
            <img src="/assets/screenshot3.png" alt="s3" style="width:160px;border-radius:6px"/>
          </div>
        </section>
      </div>

      <aside>
        <!-- Login / Portal -->
        <div class="card">
          <h3>Registro / Login</h3>
          <input id="username" placeholder="usuario" style="width:100%;margin-bottom:8px;padding:8px;background:#0f0f0f;border:1px solid #222;color:var(--text);border-radius:6px"/>
          <input id="password" type="password" placeholder="contrase√±a" style="width:100%;margin-bottom:8px;padding:8px;background:#0f0f0f;border:1px solid #222;color:var(--text);border-radius:6px"/>
          <div style="display:flex;gap:8px">
            <button id="btn-register" class="btn-primary" style="flex:1">Crear cuenta</button>
            <button id="btn-login" class="btn-primary" style="flex:1;background:#2d2d2d">Entrar</button>
          </div>
          <div id="login-msg" class="muted" style="margin-top:10px"></div>
        </div>

        <!-- Planes / PayPal -->
        <div class="card" id="portal">
          <h3>Pago / Licencia</h3>

          <!-- Selector de planes -->
          <div id="planos" style="margin-bottom:12px">
            <h4>Elige tu plan</h4>
            <div id="plan-list" style="display:flex;gap:12px;margin-top:12px;flex-wrap:wrap"></div>
          </div>

          <!-- Contenedor PayPal -->
          <div id="paypal-area">
            <div id="paypal-button-container"></div>
          </div>

          <div class="muted" style="margin-top:10px">Aceptamos PayPal. Si el bot√≥n no aparece, desactiva bloqueadores o prueba en inc√≥gnito.</div>
        </div>

        <!-- Instalar -->
        <div class="card">
          <h3>Instalar</h3>
          <p class="muted">Pulsa para descargar el userscript e instalarlo en Tampermonkey.</p>
          <button id="btn-descargar" class="cta-button" style="width:100%; background:#2196F3; color:#fff;" onclick="descargarArchivo()">üì• INSTALAR BOT</button>
        </div>
      </aside>
    </div>
  </main>

  <footer>
    &copy; GrepoTeam ‚Äî Documentaci√≥n, soporte y actualizaciones autom√°ticas.
  </footer>

  <!-- Scripts funcionales -->
  <script>
  (function(){
    // Configuraci√≥n de planes
    const PLANS = {
      '1_MES': { title: '1 Mes', price: '$7.99', desc: 'Acceso por 1 mes' },
      '6_MES': { title: '6 Meses', price: '$45.00', desc: 'Ahorra 10%' },
      '1_ANIO': { title: '1 A√±o', price: '$80.00', desc: 'Ahorra 20%' }
    };
    let selected = '1_MES';

    function renderPlanCards(){
      const container = document.getElementById('plan-list');
      container.innerHTML = '';
      Object.keys(PLANS).forEach(id=>{
        const p = PLANS[id];
        const card = document.createElement('div');
        card.className = 'plan-card' + (id===selected ? ' selected' : '');
        card.innerHTML = `<div style="font-weight:700;margin-bottom:6px">${p.title}</div>
                          <div style="font-size:18px;margin-bottom:8px">${p.price}</div>
                          <div class="muted" style="font-size:13px">${p.desc}</div>`;
        card.addEventListener('click', ()=> {
          selected = id;
          document.querySelectorAll('.plan-card').forEach(c=>c.classList.remove('selected'));
          card.classList.add('selected');
          // notificar al loader de paypal
          try { window.__Grepo_setSelectedPlan && window.__Grepo_setSelectedPlan(selected); } catch(e){ console.warn(e); }
        });
        container.appendChild(card);
      });
    }

    // Login / registro (simple, usa API real si existe)
    async function doRegister(username, password){
      try {
        const res = await fetch(location.origin + '/api/registro', {
          method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ username, password })
        });
        const j = await res.json();
        if (j.success){ window.handleLoginResponse(j); document.getElementById('login-msg').innerText = 'Registrado! ID: ' + j.usuarioId; }
        else document.getElementById('login-msg').innerText = 'Error: ' + (j.error||'registro fallido');
      } catch(e){ document.getElementById('login-msg').innerText = 'Error de conexi√≥n'; }
    }
    async function doLogin(username,password){
      try {
        const res = await fetch(location.origin + '/api/login', {
          method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ username, password })
        });
        const j = await res.json();
        if (j.success){ window.handleLoginResponse(j); document.getElementById('login-msg').innerText = 'Login OK ‚Äî ID: ' + j.usuarioId; }
        else document.getElementById('login-msg').innerText = 'Error: ' + (j.error||'no autenticado');
      } catch(e){ document.getElementById('login-msg').innerText = 'Error de conexi√≥n'; }
    }

    document.addEventListener('DOMContentLoaded', function(){
      renderPlanCards();

      document.getElementById('btn-register').addEventListener('click', ()=> doRegister(document.getElementById('username').value, document.getElementById('password').value));
      document.getElementById('btn-login').addEventListener('click', ()=> doLogin(document.getElementById('username').value, document.getElementById('password').value));

      // conectar botones de instalacion (por si no hay onclick inline)
      const topInstall = document.querySelector('#install-button');
      if (topInstall) topInstall.addEventListener('click', () => window.descargarArchivo());
      const sideInstall = document.querySelector('#btn-descargar');
      if (sideInstall) sideInstall.addEventListener('click', () => window.descargarArchivo());

      // inicializar pagos (loader se encargar√° de mostrar/ocultar)
      try { window.__Grepo_initPayments && window.__Grepo_initPayments(); } catch(e){ console.warn(e); }
    });
  })();
  </script>
</body>
</html>