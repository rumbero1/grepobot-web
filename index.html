<script>
  // Carga tolerante del SDK de PayPal y render seguro de botones
  function loadPayPalSdkAndRenderButtons(containerSelector) {
    const meta = document.querySelector('meta[name="paypal-client-id"]');
    const clientId = meta ? meta.content.trim() : '';

    // Si no hay client id, no cargamos nada y devolvemos
    if (!clientId) {
      console.warn('PayPal client-id no configurado en meta[name="paypal-client-id"]');
      hidePayPalContainer(containerSelector);
      return;
    }

    const sdkBase = 'https://www.paypal.com/sdk/js';
    const sdkUrl = `${sdkBase}?client-id=${encodeURIComponent(clientId)}&currency=USD`;

    // Evitar cargar dos veces; comprobar si ya hay un script con el mismo src (base)
    const already = Array.from(document.scripts).some(s => s.src && s.src.startsWith(sdkBase));
    if (already) {
      // si existe, esperar un poco y tratar de renderizar, con fallback si no aparece paypal
      waitForPaypalThenRender(containerSelector);
      return;
    }

    const s = document.createElement('script');
    s.src = sdkUrl;
    s.async = true;

    s.onload = () => {
      console.log('PayPal SDK cargado OK');
      waitForPaypalThenRender(containerSelector);
    };
    s.onerror = (e) => {
      console.error('Error cargando PayPal SDK', e);
      // Mostrar mensaje al usuario y no bloquear la página
      hidePayPalContainer(containerSelector);
      showPayPalErrorNotice('No se pudo cargar PayPal. Desactiva bloqueadores o prueba otro navegador.');
    };
    document.head.appendChild(s);

    // timeout por si tarda o queda pendiente
    setTimeout(() => {
      if (typeof paypal === 'undefined') {
        console.warn('PayPal SDK no disponible tras timeout');
        hidePayPalContainer(containerSelector);
      }
    }, 8000);
  }

  function waitForPaypalThenRender(containerSelector) {
    const maxWait = 8000;
    const interval = 200;
    let waited = 0;
    const t = setInterval(() => {
      if (typeof paypal !== 'undefined') {
        clearInterval(t);
        try {
          renderPayPalButtons(containerSelector);
        } catch (e) {
          console.error('Error renderizando botones PayPal', e);
          hidePayPalContainer(containerSelector);
        }
      } else {
        waited += interval;
        if (waited >= maxWait) {
          clearInterval(t);
          console.warn('paypal no disponible después de esperar');
          hidePayPalContainer(containerSelector);
        }
      }
    }, interval);
  }

  function renderPayPalButtons(containerSelector) {
    // seguridad extra: comprobar antes de usar paypal
    if (typeof paypal === 'undefined') {
      throw new Error('paypal SDK no disponible (render cancelado)');
    }

    // asegurarse de que el contenedor exista
    const container = document.querySelector(containerSelector);
    if (!container) {
      console.warn('Contenedor PayPal no encontrado:', containerSelector);
      return;
    }

    // limpiar contenedor previo
    container.innerHTML = '';

    paypal.Buttons({
      createOrder: function(data, actions) {
        return fetch(API + '/api/paypal/create-order', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({ planId: '1_MES' })
        }).then(res => res.json()).then(data => {
          if (!data || !data.id) throw new Error('No order id from server');
          return data.id;
        }).catch(err => {
          console.error('Error creando orden en backend', err);
          alert('No se pudo crear la orden. Intenta de nuevo más tarde.');
          throw err;
        });
      },
      onApprove: function(data, actions) {
        return fetch(API + '/api/paypal/capture-order', {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify({ orderID: data.orderID, usuarioId: currentUserId || null, planId: '1_MES' })
        }).then(res => res.json()).then(resp => {
          if (resp && resp.success) {
            alert('Pago recibido. Licencia activada.');
          } else {
            alert('Error en la activación del pago: ' + (resp && resp.error ? resp.error : 'unknown'));
          }
        }).catch(err => {
          console.error('Error capturando orden', err);
          alert('Error en la captura del pago.');
        });
      },
      onError: function(err) {
        console.error('PayPal Buttons error', err);
        alert('Error con PayPal. Intenta en otra ventana sin bloqueadores.');
      }
    }).render(containerSelector);
  }

  function hidePayPalContainer(containerSelector) {
    const c = document.querySelector(containerSelector);
    if (c) c.style.display = 'none';
  }
  function showPayPalErrorNotice(msg) {
    // muestra un aviso discreto para el usuario (puedes adaptar el estilo)
    const notice = document.createElement('div');
    notice.style.cssText = 'background:#ffecec;color:#8b0000;padding:10px;border-radius:6px;margin:10px 0;font-size:13px;';
    notice.innerText = msg;
    const parent = document.querySelector('#paypal-area') || document.body;
    parent.insertBefore(notice, parent.firstChild);
  }
</script>
